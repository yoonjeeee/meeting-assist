<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Meeting Assist â€” ë‹¨ì¼íŒŒì¼(ëŒ€ì‹œë³´ë“œ+PDFí•œê¸€ fix)</title>

<style>
:root{--bg:#0b0f1a;--panel:#111827;--ink:#e8eefc;--muted:#97a3b2;--line:#23314f;--accent:#3b82f6;--danger:#ef4444;--ok:#10b981}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 Inter,system-ui,Segoe UI,Malgun Gothic,sans-serif}
.nav{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;padding:12px 16px;background:#0e1423;border-bottom:1px solid var(--line)}
.brand{font-weight:800}.spacer{flex:1}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#16233d;color:#cbd5e1;border:1px solid var(--line)}
.container{max-width:1220px;margin:18px auto;padding:0 16px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 10px 32px rgb(0 0 0 / 25%)}
.hstack{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.vstack{display:flex;flex-direction:column;gap:10px}
.grid{display:grid;gap:14px}
.grid-2{grid-template-columns:420px 1fr}
.grid-3{grid-template-columns:repeat(3,1fr)}
.hidden{display:none}
label{font-size:13px;color:var(--muted)}
input,textarea,select,button{font:inherit;color:var(--ink);background:#0d1426;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
textarea{min-height:520px;resize:vertical}
button{cursor:pointer;background:var(--accent);border:none}
button.ghost{background:transparent;border:1px solid var(--line)}
button.danger{background:var(--danger)}
.small{font-size:12px;color:var(--muted)}
.list{list-style:none;margin:0;padding:0;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
.list li,.box{background:#0b1326;border:1px solid var(--line);border-radius:12px;padding:10px}

/* íƒ€ì´ë¨¸ */
.timerBox{background:#0b1326;border:1px solid var(--line);border-radius:14px;padding:12px}
#timer{font-weight:900;letter-spacing:1px}
.progress{height:10px;background:#0b1222;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:linear-gradient(90deg,#3b82f6,#22d3ee);width:0%}

/* ì²´í¬ë¦¬ìŠ¤íŠ¸ */
.ck-col{background:#0b1326;border:1px solid var(--line);border-radius:12px;padding:12px}
.ck-col h4{margin:0 0 8px 0;color:#cbd5e1}
.ck-item{display:flex;gap:10px;align-items:center;margin:6px 0}

/* ëŒ€ì‹œë³´ë“œ */
.chartGrid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.kpi{display:flex;gap:10px;align-items:center;background:#0b1326;border:1px solid var(--line);border-radius:12px;padding:10px}
.kpi strong{font-size:18px}
</style>
</head>
<body>
  <nav class="nav">
    <a href="#" class="brand" data-view="meet">Meeting Assist</a>
    <span id="mode" class="badge">ëª¨ë“œ í™•ì¸ ì¤‘â€¦</span>
    <div class="spacer"></div>
    <a href="#" data-view="meet">íšŒì˜ í™”ë©´</a>
    <a href="#" data-view="dash">ëŒ€ì‹œë³´ë“œ</a>
    <button id="save" class="ghost">ì €ì¥</button>
    <button id="dlPdf" class="ghost">PDF</button>
    <button id="dlDocx" class="ghost">Word</button>
    <button id="dlCsv" class="ghost">CSV(í›„ì†)</button>
  </nav>

  <div class="container">
    <!-- ===== íšŒì˜ í™”ë©´ ===== -->
    <section id="view-meet" class="vstack">
      <div class="card grid grid-2">
        <!-- ì¢Œ: íšŒì˜ë¡ -->
        <section class="vstack">
          <h3>ğŸ“ íšŒì˜ë¡</h3>
          <div class="hstack">
            <button id="insertStamp" class="ghost">â± íƒ€ì„ìŠ¤íƒ¬í”„</button>
            <button id="clearNotes" class="ghost">ì§€ìš°ê¸°</button>
            <span id="saveState" class="small">ì €ì¥ ëŒ€ê¸°â€¦</span>
          </div>
          <!-- PDF ìº¡ì²˜ìš© ë˜í¼ -->
          <div id="exportArea" class="box">
            <h2 id="expTitle" style="margin-top:0">íšŒì˜ ì œëª©</h2>
            <p class="small" id="expMeta">ì„¤ì •: -ë¶„ / ì‹¤ì œ: -ë¶„ / ìƒíƒœ: -</p>
            <h3>íšŒì˜ë¡</h3>
            <div id="expNotes" style="white-space:pre-wrap"></div>
            <h3>í›„ì†ì¡°ì¹˜</h3>
            <ul id="expActions" style="margin:0;padding-left:18px"></ul>
            <h3>íŒŒí‚¹ë</h3>
            <ul id="expParking" style="margin:0;padding-left:18px"></ul>
            <h3>ì²´í¬ë¦¬ìŠ¤íŠ¸ ìš”ì•½</h3>
            <ul id="expChecklist" style="margin:0;padding-left:18px"></ul>
          </div>
          <textarea id="notes" placeholder="ë„“ì€ ì„¸ë¡œí˜• ë©”ëª¨ ê³µê°„ì…ë‹ˆë‹¤. ëª©ì /ë°°ê²½, ì•ˆê±´, ê²°ì •ì‚¬í•­ ë“± ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”."></textarea>
        </section>

        <!-- ìš°: ì •ë³´ + íƒ€ì´ë¨¸ + í›„ì†ì¡°ì¹˜ + íŒŒí‚¹ë -->
        <section class="vstack">
          <h3>ğŸ—‚ íšŒì˜ ì •ë³´ & íƒ€ì´ë¨¸</h3>
          <div class="box">
            <div class="hstack" style="gap:12px">
              <label style="flex:1">íšŒì˜ ì œëª©* <input id="title" placeholder="ì˜ˆ: ì „ëµ íšŒì˜"/></label>
              <label>íšŒì˜ ì‹œê°„*
                <select id="plan">
                  <option>30</option><option>45</option><option>60</option>
                  <option>75</option><option>90</option><option>105</option><option>120</option>
                </select>
              </label>
            </div>
            <div class="timerBox vstack">
              <div class="hstack">
                <span class="badge">ì„¤ì •: <span id="lblPlan">60</span>ë¶„</span>
                <span class="badge">ìƒíƒœ: <span id="lblStatus">ready</span></span>
                <span class="badge">ì‹¤ì œ: <span id="lblReal">0</span>ë¶„</span>
              </div>
              <div class="hstack">
                <div id="timer" style="font-size:40px">00:00</div>
                <button id="start">ì‹œì‘</button>
                <button id="pause" class="ghost">ì¼ì‹œì •ì§€</button>
                <button id="reset" class="ghost">ë¦¬ì…‹</button>
                <button id="end" class="danger">ì¢…ë£Œ</button>
              </div>
              <div class="progress"><div id="bar"></div></div>
              <span class="small">ë‚¨ì€ ì‹œê°„ ì•Œë¦¼: T-10 / T-5</span>
            </div>
          </div>

          <!-- í›„ì†ì¡°ì¹˜ -->
          <div class="box vstack">
            <div class="hstack"><h4 style="margin:0">ğŸ“Œ í›„ì†ì¡°ì¹˜</h4><span class="small">ë‹´ë‹¹/ê¸°í•œ í¬í•¨</span></div>
            <div class="hstack">
              <input id="acTask" placeholder="ë¬´ì—‡ì„?"/>
              <input id="acOwner" placeholder="ë‹´ë‹¹ì"/>
              <input id="acDue" type="date"/>
              <button id="acAdd">ì¶”ê°€</button>
            </div>
            <table class="tbl" id="acTbl">
              <thead><tr><th>í•  ì¼</th><th>ë‹´ë‹¹</th><th>ê¸°í•œ</th><th>ì™„ë£Œ</th><th>ì‚­ì œ</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- íŒŒí‚¹ë -->
          <div class="box vstack">
            <div class="hstack"><h4 style="margin:0">ğŸ…¿ íŒŒí‚¹ë</h4><span class="small">ì§€ê¸ˆ ì²˜ë¦¬ ë¶ˆê°€ â†’ í›„ì†ìœ¼ë¡œ</span></div>
            <div class="hstack">
              <input id="plItem" placeholder="ë³´ë¥˜í•  ì£¼ì œ"/>
              <button id="plAdd">ì¶”ê°€</button>
            </div>
            <ul id="plList" class="list"></ul>
          </div>
        </section>
      </div>

      <!-- í•˜ë‹¨: ì²´í¬ë¦¬ìŠ¤íŠ¸(ì „/ì¤‘/í›„ ê° 5ê°œ) -->
      <div class="card">
        <h3>âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸(15)</h3>
        <div class="grid grid-3">
          <div class="ck-col">
            <h4>íšŒì˜ ì „</h4>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="pre_goal">ëª©ì /ì„±ê³¼ì§€í‘œ ëª…í™•</label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="pre_agenda">ì•ˆê±´Â·ìë£Œ ì‚¬ì „ ê³µìœ </label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="pre_attendee">í•„ìˆ˜ ì°¸ì„ì/ê²°ì •ê¶Œì í™•ì¸</label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="pre_timebox">ì‹œê°„ì œí•œ í•©ì˜(30â€“120)</label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="pre_roles">ì—­í•  ë°°ì •(ì§„í–‰/ê¸°ë¡/íƒ€ì„í‚¤í¼)</label>
          </div>
          <div class="ck-col">
            <h4>íšŒì˜ ì¤‘</h4>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="mid_scope">íƒˆì„ ì€ íŒŒí‚¹ëìœ¼ë¡œ ë¶„ë¦¬</label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="mid_time">ì•ˆê±´ë³„ ì‹œê°„ ì¤€ìˆ˜</label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="mid_decision">ê²°ì •ì‚¬í•­Â·ê·¼ê±° ê¸°ë¡</label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="mid_risk">ë¦¬ìŠ¤í¬/ì˜ì¡´ì„± ì‹ë³„</label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="mid_actions">í›„ì†ì¡°ì¹˜ ì´ˆì•ˆ(ë‹´ë‹¹/ê¸°í•œ)</label>
          </div>
          <div class="ck-col">
            <h4>íšŒì˜ í›„</h4>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="post_owner">ë‹´ë‹¹Â·ê¸°í•œ í™•ì •/ìº˜ë¦°ë” ë°˜ì˜</label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="post_minutes">íšŒì˜ë¡ ê³µìœ (ìš”ì•½/ê²°ì •/ì•¡ì…˜)</label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="post_follow">íŒŒí‚¹ë íŒ”ë¡œìš°ì—… ì¼ì •í™”</label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="post_review">íƒ€ì„ë°•ì‹± ì¤€ìˆ˜ íšŒê³ </label>
            <label class="ck-item"><input type="checkbox" class="ck" data-k="post_feedback">ê°œì„  í”¼ë“œë°± ìˆ˜ì§‘</label>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== ëŒ€ì‹œë³´ë“œ(ì¼/ì£¼/ì›”/ì—° í‰ê·  íšŒì˜ì‹œê°„ íŒŒì´ì°¨íŠ¸) ===== -->
    <section id="view-dash" class="hidden vstack">
      <div class="card">
        <h3>ğŸ“Š ì „ì‚¬ ëŒ€ì‹œë³´ë“œ</h3>
        <div class="hstack">
          <div class="kpi"><strong id="kpiCnt">-</strong><span class="small">ì´ íšŒì˜ ìˆ˜</span></div>
          <div class="kpi"><strong id="kpiSum">-</strong><span class="small">ì´ íšŒì˜ ì‹œê°„(ë¶„)</span></div>
          <div class="kpi"><strong id="kpiAvg">-</strong><span class="small">í‰ê·  íšŒì˜ ì‹œê°„(ë¶„)</span></div>
        </div>
      </div>
      <div class="card">
        <div class="chartGrid">
          <div><h4>ì¼ í‰ê· </h4><canvas id="cDay"></canvas></div>
          <div><h4>ì£¼ í‰ê· </h4><canvas id="cWeek"></canvas></div>
          <div><h4>ì›” í‰ê· </h4><canvas id="cMonth"></canvas></div>
          <div><h4>ì—° í‰ê· </h4><canvas id="cYear"></canvas></div>
        </div>
      </div>
    </section>
  </div>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬: Chart.js + jsPDF + html2canvas + FileSaver + docx -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>

  <!-- ì•± ë¡œì§ -->
  <script type="module">
  // ===== ë·° ì „í™˜ =====
  const $=(s)=>document.querySelector(s);
  const mode=$("#mode");
  function show(v){ ["meet","dash"].forEach(x=>$("#view-"+x).classList.add("hidden")); $("#view-"+v).classList.remove("hidden"); }
  document.querySelectorAll('[data-view]').forEach(a=>a.onclick=(e)=>{e.preventDefault(); show(a.dataset.view); if(a.dataset.view==="dash") renderDashboard();});
  show("meet");

  // ===== íšŒì˜ í™”ë©´ ìš”ì†Œ =====
  const title=$("#title"), plan=$("#plan");
  const lblPlan=$("#lblPlan"), lblStatus=$("#lblStatus"), lblReal=$("#lblReal");
  const timerEl=$("#timer"), bar=$("#bar"), startBtn=$("#start"), pauseBtn=$("#pause"), resetBtn=$("#reset"), endBtn=$("#end");
  const notes=$("#notes"), saveBtn=$("#save"), saveState=$("#saveState");
  const acTask=$("#acTask"), acOwner=$("#acOwner"), acDue=$("#acDue"), acAdd=$("#acAdd"), acTbl=$("#acTbl tbody");
  const plItem=$("#plItem"), plAdd=$("#plAdd"), plList=$("#plList");
  const dlPdf=$("#dlPdf"), dlDocx=$("#dlDocx"), dlCsv=$("#dlCsv");
  const insertStamp=$("#insertStamp"), clearNotes=$("#clearNotes");

  // PDF export area refs
  const expTitle=$("#expTitle"), expMeta=$("#expMeta"), expNotes=$("#expNotes"), expActions=$("#expActions"), expParking=$("#expParking"), expChecklist=$("#expChecklist");
  const exportArea=$("#exportArea");

  // ===== íƒ€ì´ë¨¸ =====
  lblPlan.textContent=plan.value;
  plan.onchange=()=>{lblPlan.textContent=plan.value; updateProgress(0);};
  let seconds=0, handle=null, warned10=false, warned5=false;
  const fmt=(s)=>`${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;
  const updateProgress=(s=seconds)=>{const limit=Number(plan.value)*60; bar.style.width=Math.min(100,Math.round((s/limit)*100))+"%";}
  const beep=()=>{const C=window.AudioContext||window.webkitAudioContext; const c=new C(); const o=c.createOscillator(), g=c.createGain(); o.type="sine"; o.frequency.value=900; g.gain.value=0.05; o.connect(g); g.connect(c.destination); o.start(); setTimeout(()=>{o.stop();c.close();},220);}
  const tick=()=>{seconds++; timerEl.textContent=fmt(seconds); lblReal.textContent=Math.round(seconds/60); updateProgress(); const remain=Number(plan.value)*60-seconds; if(!warned10&&remain===600){warned10=true;beep();alert("ë‚¨ì€ ì‹œê°„ 10ë¶„!");} if(!warned5&&remain===300){warned5=true;beep();alert("ë‚¨ì€ ì‹œê°„ 5ë¶„!");}}
  const startTimer=()=>{if(handle) return; handle=setInterval(tick,1000); lblStatus.textContent="running";}
  const pauseTimer=()=>{if(handle){clearInterval(handle); handle=null; lblStatus.textContent="paused";}}
  const resetTimer=()=>{pauseTimer(); seconds=0; timerEl.textContent="00:00"; lblReal.textContent="0"; warned10=false; warned5=false; updateProgress(0); lblStatus.textContent="ready";}

  startBtn.onclick=()=>startTimer();
  pauseBtn.onclick=()=>pauseTimer();
  resetBtn.onclick=()=>resetTimer();
  endBtn.onclick=async()=>{pauseTimer(); lblStatus.textContent="ended"; await saveAll(true); alert(`íšŒì˜ ì¢…ë£Œ(ì´ ${Math.round(seconds/60)}ë¶„)`);};

  // ===== ë…¸íŠ¸ ìœ í‹¸ =====
  insertStamp.onclick=()=>{const ts=new Date().toLocaleTimeString(); notes.setRangeText(`[${ts}] `, notes.selectionStart, notes.selectionEnd, "end"); notes.dispatchEvent(new Event("input"));};
  clearNotes.onclick=()=>{if(confirm("íšŒì˜ë¡ì„ ì§€ìš¸ê¹Œìš”?")){notes.value=""; notes.dispatchEvent(new Event("input"));}}

  // ===== í›„ì†ì¡°ì¹˜ / íŒŒí‚¹ë =====
  let actions=[], parking=[];
  function redrawActions(){ acTbl.innerHTML=""; actions.forEach((a,i)=>{ const tr=document.createElement("tr"); tr.innerHTML=`
      <td>${a.task}</td><td>${a.owner||"-"}</td><td>${a.due||"-"}</td>
      <td><input type="checkbox" ${a.done?"checked":""}></td>
      <td><button class="ghost">ì‚­ì œ</button></td>`;
    tr.querySelector('input[type="checkbox"]').onchange=e=>{actions[i].done=e.target.checked; saveAll(false);};
    tr.querySelector('button').onclick=()=>{actions.splice(i,1); redrawActions(); saveAll(false);};
    acTbl.appendChild(tr);
  });}
  acAdd.onclick=()=>{const t=acTask.value.trim(); if(!t) return alert("í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"); actions.push({task:t, owner:acOwner.value.trim()||"", due:acDue.value||"", done:false}); acTask.value=""; acOwner.value=""; acDue.value=""; redrawActions(); saveAll(false);}

  function redrawPL(){ plList.innerHTML=""; parking.forEach((p,i)=>{ const li=document.createElement("li"); li.className="box"; li.textContent=p; const b=document.createElement("button"); b.textContent="ì‚­ì œ"; b.className="ghost"; b.style.marginLeft="10px"; b.onclick=()=>{parking.splice(i,1); redrawPL(); saveAll(false);}; li.appendChild(b); plList.appendChild(li); });}
  plAdd.onclick=()=>{const v=plItem.value.trim(); if(!v) return; parking.push(v); plItem.value=""; redrawPL(); saveAll(false);}

  // ===== ì²´í¬ë¦¬ìŠ¤íŠ¸ ë°”ì¸ë”© =====
  const ckInputs=[...document.querySelectorAll(".ck")];
  ckInputs.forEach(i=> i.onchange=()=>saveAll(false));

  // ===== ë‹¤ìš´ë¡œë“œ: Word(ê·¸ëŒ€ë¡œ), CSV(í›„ì†), PDF(í•œê¸€ ë³´ì¡´) =====
  dlDocx.onclick=()=>{
    const html = `
      <h1>${title.value||"(ì œëª© ì—†ìŒ)"}</h1>
      <p><strong>ì„¤ì •:</strong> ${plan.value}ë¶„ / <strong>ì‹¤ì œ:</strong> ${Math.round(seconds/60)}ë¶„ / <strong>ìƒíƒœ:</strong> ${lblStatus.textContent}</p>
      <h2>íšŒì˜ë¡</h2><p>${(notes.value||"").replace(/\n/g,"<br/>")}</p>
      <h2>í›„ì†ì¡°ì¹˜</h2><p>${actions.map(a=>`- ${a.task} / ë‹´ë‹¹:${a.owner||"-"} / ê¸°í•œ:${a.due||"-"} / ì™„ë£Œ:${a.done?"Y":"N"}`).join("<br/>")||"(ì—†ìŒ)"}</p>
      <h2>íŒŒí‚¹ë</h2><p>${parking.map(p=>`- ${p}`).join("<br/>")||"(ì—†ìŒ)"}</p>`;
    const blob=window.htmlDocx.asBlob(`<!doctype html><html><head><meta charset="utf-8"></head><body>${html}</body></html>`);
    saveAs(blob,"meeting.docx");
  };
  dlCsv.onclick=()=>{
    const rows=[["task","owner","due","done"]];
    actions.forEach(a=>rows.push([a.task,a.owner,a.due,a.done?"Y":"N"]));
    const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); saveAs(blob,"actions.csv");
  };
  dlPdf.onclick=async ()=>{
    // í™”ë©´ì˜ exportAreaë¥¼ ì´ë¯¸ì§€ë¡œ ìº¡ì²˜ â†’ PDFì— ì‚½ì…(í•œê¸€ ë³´ì¡´)
    expTitle.textContent = title.value||"(ì œëª© ì—†ìŒ)";
    expMeta.textContent  = `ì„¤ì •: ${plan.value}ë¶„ / ì‹¤ì œ: ${Math.round(seconds/60)}ë¶„ / ìƒíƒœ: ${lblStatus.textContent}`;
    expNotes.textContent = notes.value||"(ë‚´ìš© ì—†ìŒ)";
    expActions.innerHTML = actions.length? actions.map(a=>`<li>${a.task} / ë‹´ë‹¹:${a.owner||"-"} / ê¸°í•œ:${a.due||"-"} / ì™„ë£Œ:${a.done?"Y":"N"}</li>`).join("") : "<li>(ì—†ìŒ)</li>";
    expParking.innerHTML = parking.length? parking.map(p=>`<li>${p}</li>`).join("") : "<li>(ì—†ìŒ)</li>";
    const checked = ckInputs.filter(i=>i.checked).map(i=>i.parentElement.textContent.trim());
    expChecklist.innerHTML = checked.length? checked.map(t=>`<li>${t}</li>`).join("") : "<li>(ì—†ìŒ)</li>";

    const canvas = await html2canvas(exportArea, {scale:2, backgroundColor:"#111827"});
    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:"pt", format:"a4"});
    const pageWidth = pdf.internal.pageSize.getWidth();
    const ratio = pageWidth / canvas.width;
    const imgH = canvas.height * ratio;
    pdf.addImage(imgData, "PNG", 0, 0, pageWidth, imgH);
    pdf.save("meeting.pdf");
  };

  // ===== ì €ì¥(í´ë¼ìš°ë“œ or ë¡œì»¬) =====
  let useDB=false, db=null, addDocFn=null, updateDocFn=null, docFn=null, collectionFn=null, serverTimestampFn=null, getDocsFn=null, queryFn=null, orderByFn=null;
  let currentId=null;

  // Firebase ë™ì  ë¡œë“œ(ì„¤ì • ë„£ìœ¼ë©´ í´ë¼ìš°ë“œ ëª¨ë“œ)
  try{
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js");
    const fw = await import("https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js");
    const firebaseConfig = {
      /* const firebaseConfig = {
  apiKey: "AIzaSyCpTt5E2JYjsvjjFEh_QG0YVElFgYJ0jX8",
  authDomain: "meeting-assit-site.firebaseapp.com",
  projectId: "meeting-assit-site",
  storageBucket: "meeting-assit-site.firebasestorage.app",
  messagingSenderId: "289914417857",
  appId: "1:289914417857:web:7abefc88883b29eafeda40",
  measurementId: "G-PE7WSSQ5EX"
};
      apiKey:"...", authDomain:"...", projectId:"...", appId:"..."
      */
    };
    if(!Object.keys(firebaseConfig).length) throw new Error("No Firebase config");
    const app = initializeApp(firebaseConfig);
    db=fw.getFirestore(app);
    addDocFn=fw.addDoc; updateDocFn=fw.updateDoc; docFn=fw.doc; collectionFn=fw.collection; serverTimestampFn=fw.serverTimestamp;
    getDocsFn=fw.getDocs; queryFn=fw.query; orderByFn=fw.orderBy;
    useDB=true; mode.textContent="í´ë¼ìš°ë“œ ëª¨ë“œ"; mode.style.background="#12396c";
  }catch(e){
    useDB=false; mode.textContent="ë¡œì»¬ ëª¨ë“œ"; mode.style.background="#5b3415";
  }

  // ìë™ì €ì¥
  let deb=null; const debSave=(fn,ms)=>{if(deb) clearTimeout(deb); deb=setTimeout(fn,ms);};
  notes.addEventListener("input", ()=>{saveState.textContent="ì €ì¥ ì¤‘â€¦"; debSave(()=>saveAll(false), 400);});
  [title, plan].forEach(el=> el.addEventListener("change", ()=>saveAll(false)) );
  saveBtn.onclick=()=>saveAll(false);

  async function saveAll(ended){
    const payload={
      title:(title.value||"").trim(),
      plannedMinutes:Number(plan.value),
      actualMinutes:Math.round(seconds/60),
      status: ended? "ended" : lblStatus.textContent,
      notes: notes.value||"",
      actions, parking,
      checklist: Object.fromEntries([...document.querySelectorAll(".ck")].map(i=>[i.dataset.k, i.checked])),
      updatedAt: Date.now()
    };
    if(!payload.title||!payload.plannedMinutes){ saveState.textContent="ì œëª©/ì‹œê°„ í•„ìš”"; return; }

    try{
      if(useDB){
        if(!currentId){
          const ref = await addDocFn(collectionFn(db,"meetings"), {...payload, createdAt: serverTimestampFn()});
          currentId = ref.id;
        }else{
          await updateDocFn(docFn(db,"meetings",currentId), payload);
        }
        saveState.textContent="ì €ì¥ë¨(í´ë¼ìš°ë“œ)";
      }else{
        const key=currentId||("local_"+Date.now());
        currentId=key;
        const all = JSON.parse(localStorage.getItem("meetings_local")||"[]").filter(x=>x.id!==key);
        all.unshift({id:key,...payload});
        while(all.length>50) all.pop();
        localStorage.setItem("meetings_local", JSON.stringify(all));
        saveState.textContent="ì €ì¥ë¨(ë¡œì»¬)";
      }
    }catch(err){
      console.error(err); saveState.textContent="ì €ì¥ ì˜¤ë¥˜";
    }finally{
      setTimeout(()=>saveState.textContent="ì €ì¥ ëŒ€ê¸°â€¦",1200);
    }
  }

  // ===== ëŒ€ì‹œë³´ë“œ(ì¼/ì£¼/ì›”/ì—° í‰ê·  íŒŒì´ì°¨íŠ¸) â€” ë¡œì»¬/í´ë¼ìš°ë“œ ëª¨ë‘ ì§€ì› =====
  let charts=[];
  async function renderDashboard(){
    let rows=[]; // {minutes, date}
    if(useDB){
      const s = await getDocsFn(queryFn(collectionFn(db,"meetings"), orderByFn("updatedAt","desc")));
      s.forEach(d=>{
        const m=d.data();
        const minutes = Number(m.actualMinutes ?? m.plannedMinutes ?? 0);
        const ts = m.updatedAt ? new Date(m.updatedAt) : new Date();
        rows.push({minutes, date: ts});
      });
    }else{
      const all = JSON.parse(localStorage.getItem("meetings_local")||"[]");
      rows = all.map(m=>({minutes:Number(m.actualMinutes ?? m.plannedMinutes ?? 0), date:new Date(m.updatedAt||Date.now())}));
    }

    // KPI
    const cnt=rows.length, sum=rows.reduce((a,b)=>a+(b.minutes||0),0), avg=cnt?Math.round(sum/cnt):0;
    $("#kpiCnt").textContent=cnt; $("#kpiSum").textContent=sum; $("#kpiAvg").textContent=avg;

    // grouping
    const pad=n=>String(n).padStart(2,"0");
    const dayKey = d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const monthKey=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}`;
    const yearKey = d=>`${d.getFullYear()}`;
    const weekKey = d=>{ const date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=date.getUTCDay()||7; date.setUTCDate(date.getUTCDate()+4-day); const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1)); const week=Math.ceil((((date-yearStart)/86400000)+1)/7); return `${date.getUTCFullYear()}-W${pad(week)}`; };

    function avgBy(keyer){
      const map=new Map();
      rows.forEach(r=>{const k=keyer(r.date); const cur=map.get(k)||{sum:0,cnt:0}; cur.sum+=r.minutes; cur.cnt++; map.set(k,cur);});
      const labels=[...map.keys()].sort();
      const data=labels.map(k=>Math.round(map.get(k).sum/map.get(k).cnt||0));
      return {labels,data};
    }
    const dDay=avgBy(dayKey), dWeek=avgBy(weekKey), dMonth=avgBy(monthKey), dYear=avgBy(yearKey);

    // ê·¸ë¦¬ê¸°
    charts.forEach(c=>c.destroy()); charts=[];
    charts.push(new Chart(document.getElementById("cDay"),  {type:"pie", data:{labels:dDay.labels,  datasets:[{data:dDay.data}]}}));
    charts.push(new Chart(document.getElementById("cWeek"), {type:"pie", data:{labels:dWeek.labels, datasets:[{data:dWeek.data}]}}));
    charts.push(new Chart(document.getElementById("cMonth"),{type:"pie", data:{labels:dMonth.labels,datasets:[{data:dMonth.data}]}}));
    charts.push(new Chart(document.getElementById("cYear"), {type:"pie", data:{labels:dYear.labels, datasets:[{data:dYear.data}]}}));
  }
  </script>
</body>
</html>
